

<!DOCTYPE html>
<html lang="ch_CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="waterbang">
  <meta name="keywords" content="waterbang">
  
    <meta name="description" content="preface âš ï¸ This IS MY FIRST ATTEMPT TO write IN English. Please note that the following code may be wrong. It is still being modified.  javascript using op to call rust is relatively simple, and the D">
<meta property="og:type" content="article">
<meta property="og:title" content="Deno uses OP to call javaScript">
<meta property="og:url" content="https://www.waterbang.top/2022/08/10/Deno_uses_OP_to_call_javaScript/index.html">
<meta property="og:site_name" content="waterbang">
<meta property="og:description" content="preface âš ï¸ This IS MY FIRST ATTEMPT TO write IN English. Please note that the following code may be wrong. It is still being modified.  javascript using op to call rust is relatively simple, and the D">
<meta property="og:locale" content="ch_CN">
<meta property="article:published_time" content="2022-08-10T13:22:28.000Z">
<meta property="article:modified_time" content="2024-12-21T11:43:23.182Z">
<meta property="article:author" content="waterbang">
<meta property="article:tag" content="deno javascript">
<meta name="twitter:card" content="summary_large_image">
  
  
  <title>Deno uses OP to call javaScript ğŸ® waterbang</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/atom-one-dark.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"www.waterbang.top","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":"ğŸ¦"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":"58e161bf4b884b2aa577f323f137ac0f","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>waterbang</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Startseite
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archiv
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Etiketten
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                Ãœber mich
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                Weblinks
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/post-banner.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Deno uses OP to call javaScript">
              
            </span>

            
              <div class="mt-3">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-author" aria-hidden="true"></i>
      waterbang
    </span>
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-08-10 21:22" pubdate>
        August 10, 2022 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      4.1k å­—
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      35 åˆ†é’Ÿ
    </span>
  

  
  
    
      <!-- ä¸è’œå­ç»Ÿè®¡æ–‡ç« PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> æ¬¡
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Deno uses OP to call javaScript</h1>
            
              <p class="note note-info">
                
                  æœ¬æ–‡æœ€åæ›´æ–°äºï¼š5 hours ago
                
              </p>
            
            <div class="markdown-body">
              <h2 id="preface"><a href="#preface" class="headerlink" title="preface"></a>preface</h2><blockquote>
<p>âš ï¸ This IS MY FIRST ATTEMPT TO write IN English. Please note that the following code may be wrong. It is still being modified.</p>
</blockquote>
<p><code>javascript</code> using <code>op</code> to call <code>rust</code> is relatively simple, and the <code>Deno</code> source code also has many examples.<br>This paper mainly focuses on how <code>deno</code> calls<code>javascript</code>, or in another way, how to give <code>deno</code> data to <code>javascript</code>.<br>The approach in this paper is to write polling functions in javascript that constantly ask rust for data. To achieve back pressure.</p>
<h3 id="How-to-write"><a href="#How-to-write" class="headerlink" title="How to write"></a>How to write</h3><p>The pseudocode is as follows.</p>
<figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-comment">// Remember to register the OP function with the JS Runtime</span><br>[op]<br><span class="hljs-title function_ invoke__">op_rust_to_js_buffer</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-type">Vec</span>&lt;<span class="hljs-type">u8</span>&gt;,AnyError&gt; &#123;<br> <span class="hljs-comment">// This DATA is a global static variable</span><br>  <span class="hljs-keyword">match</span> DATA &#123;<br>    <span class="hljs-title function_ invoke__">Some</span>(r)=&gt; &#123;<span class="hljs-title function_ invoke__">Ok</span>(r)&#125;ï¼Œ<br>    <span class="hljs-title function_ invoke__">Err</span>(e) =&gt; &#123;deno_core::error::custom_error&#123;<br>      <span class="hljs-string">&quot;op_rust_to_js_buffer&quot;</span>,<br>      <span class="hljs-string">&quot;no Found data&quot;</span><br>    &#125;&#125;<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">op_rust_to_js_buffer</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">const</span> buffer = <span class="hljs-title class_">Deno</span>.<span class="hljs-property">core</span>.<span class="hljs-title function_">opSync</span>(<span class="hljs-string">&quot;op_rust_to_js_buffer&quot;</span>);  <span class="hljs-comment">// return Vec&lt;u8&gt; -&gt; Unit8Array</span><br>    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Textdecoder</span>().<span class="hljs-title function_">decode</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Unit8Array</span>(buffer));<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result);<br>    <span class="hljs-keyword">return</span> result;<br>  &#125;<span class="hljs-keyword">catch</span>(e) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">handlerFactory</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> data = <span class="hljs-title function_">op_rust_to_js_buffer</span>(); <span class="hljs-comment">// server boom </span><br>    <span class="hljs-comment">//....</span><br>  &#125;);<br>&#125;<br><span class="hljs-title function_">handlerFactory</span>();<br></code></pre></div></td></tr></table></figure>

<p>Iâ€™ve tried the following, but it has a heap overflow.</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">op_rust_to_js_buffer</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">const</span> buffer = <span class="hljs-title class_">Deno</span>.<span class="hljs-property">core</span>.<span class="hljs-title function_">opAsync</span>(<span class="hljs-string">&quot;op_rust_to_js_buffer&quot;</span>).<span class="hljs-title function_">then</span>();  <span class="hljs-comment">// return Vec&lt;u8&gt; -&gt; Unit8Array</span><br>      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Textdecoder</span>().<span class="hljs-title function_">decode</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Unit8Array</span>(buffer));<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result);<br>      <span class="hljs-title function_">resolve</span>(result)<br>    &#125;<span class="hljs-keyword">catch</span>(e) &#123;<br>      <span class="hljs-title function_">reject</span>(e);<br>    &#125;<br>  &#125;).<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">op_rust_to_js_buffer</span>())<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/Gaubee">Gaubee</a>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">/// ä¸¤ä¸ªæ ¸å¿ƒå‡½æ•°</span><br><span class="hljs-keyword">const</span> callRust = <span class="hljs-title class_">Deno</span>.<span class="hljs-property">core</span>.<span class="hljs-title function_">opSync</span>(<span class="hljs-string">&quot;op_js_to_rust&quot;</span>);<br><span class="hljs-keyword">const</span> waitRustBuffer = <span class="hljs-title class_">Deno</span>.<span class="hljs-property">core</span>.<span class="hljs-title function_">opAsync</span>(<span class="hljs-string">&quot;op_rust_to_js_buffer&quot;</span>);<br><br><span class="hljs-comment">/// åŸå§‹çš„è°ƒç”¨</span><br><span class="hljs-keyword">let</span> acc_call_id = <span class="hljs-number">0</span>;<br>&#123;<br>  <span class="hljs-keyword">const</span> callId = acc_call_id++;<br>  <span class="hljs-title function_">callRust</span>(callId, ...some_args);<br><br>  <span class="hljs-keyword">const</span> buffer1 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">waitRustBuffer</span>(callId);<br>  <span class="hljs-keyword">const</span> buffer2 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">waitRustBuffer</span>(callId);<br>  <span class="hljs-keyword">const</span> buffer3 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">waitRustBuffer</span>(callId);<br>  <span class="hljs-comment">//...</span><br>&#125;<br><br><span class="hljs-comment">/// æ·±åº¦å°è£…</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyModule</span> &#123;<br>  private <span class="hljs-keyword">static</span> _acc_id = <span class="hljs-number">0</span>;<br>  private _id = <span class="hljs-title class_">MyModule</span>.<span class="hljs-property">_acc_id</span>++;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * ç¬¬ä¸€ç§å°è£…ï¼Œä½¿ç”¨ AsyncGenerator</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">async</span> *<span class="hljs-title function_">call1</span>(<span class="hljs-params">...args</span>) &#123;<br>    <span class="hljs-keyword">const</span> callId = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_id</span>;<br>    <span class="hljs-title function_">callRust</span>(callId, ...args);<br><br>    <span class="hljs-keyword">do</span> &#123;<br>      <span class="hljs-keyword">const</span> buffer1 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">waitRustBuffer</span>(callId);<br>      <span class="hljs-comment">/// åŸºäºæ•°æ®çš„è§„èŒƒï¼Œæ¥å®šä¹‰ä»€ä¹ˆæ—¶å€™ç»“æŸ</span><br>      <span class="hljs-keyword">if</span> (buffer1.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">break</span>;<br>      &#125;<br>      <span class="hljs-comment">/// è¿”å›æ•°æ®</span><br>      <span class="hljs-keyword">yield</span> buffer1;<br>      <span class="hljs-comment">/// è¿™é‡Œæ˜¯é‡ç‚¹ï¼Œä½¿ç”¨ do-while ï¼Œæ›¿ä»£ finallyï¼Œå¯ä»¥é¿å…å †æ ˆæº¢å‡ºã€‚</span><br>    &#125; <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>);<br>  &#125;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * ç¬¬äºŒç§å°è£…ï¼Œæ‰‹å†™ AsyncGenerator</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-title function_">call2</span>(<span class="hljs-params">...args</span>) &#123;<br>    <span class="hljs-keyword">const</span> callId = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_id</span>;<br>    <span class="hljs-title function_">callRust</span>(callId, ...args);<br><br>    <span class="hljs-keyword">return</span> &#123;<br>      <span class="hljs-keyword">async</span> <span class="hljs-title function_">next</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">await</span> <span class="hljs-title function_">waitRustBuffer</span>(callId);<br>        <span class="hljs-keyword">return</span> &#123;<br>          <span class="hljs-attr">value</span>: buffer,<br>          <span class="hljs-attr">done</span>: buffer.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>,<br>        &#125;;<br>      &#125;,<br>      <span class="hljs-keyword">return</span>() &#123;<br>        <span class="hljs-comment">/// è¿™é‡Œå¯ä»¥æ‰‹åŠ¨æ§åˆ¶å¼‚æ­¥è¿­ä»£å™¨è¢« â€œä¸­æ­¢â€ é‡Šæ”¾</span><br>      &#125;,<br>      <span class="hljs-keyword">throw</span>() &#123;<br>        <span class="hljs-comment">/// è¿™é‡Œå¯ä»¥æ‰‹åŠ¨æ§åˆ¶å¼‚æ­¥è¿­ä»£å™¨è¢« â€œä¸­æ­¢â€ é‡Šæ”¾</span><br>      &#125;,<br>    &#125;;<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>æ•´ç†äº†ä¸€ä¸‹ï¼š</p>
<figure class="highlight typescript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loopRustBuffer</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-keyword">async</span> <span class="hljs-title function_">next</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-keyword">let</span> buffer = <span class="hljs-literal">null</span>;<br>      <span class="hljs-keyword">try</span> &#123;<br>        buffer = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Deno</span>.<span class="hljs-property">core</span>.<span class="hljs-title function_">opAsync</span>(<span class="hljs-string">&quot;op_rust_to_js_buffer&quot;</span>);<br>        <span class="hljs-keyword">const</span> <span class="hljs-built_in">string</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>().<span class="hljs-title function_">decode</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(buffer));<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;rust send message to deno_js:&quot;</span>, <span class="hljs-built_in">string</span>);<br>        <span class="hljs-keyword">return</span> &#123;<br>          <span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span>,<br>          <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span>,<br>        &#125;;<br>      &#125; <span class="hljs-keyword">catch</span> (e) &#123;<br>        <span class="hljs-keyword">return</span> &#123;<br>          <span class="hljs-attr">value</span>: buffer,<br>          <span class="hljs-attr">done</span>: <span class="hljs-literal">true</span>,<br>        &#125;;<br>      &#125;<br>    &#125;,<br>    <span class="hljs-keyword">return</span>() &#123;<br>      <span class="hljs-comment">/// Here you can manually control the asynchronous iterator to be &quot;aborted&quot; and released</span><br>    &#125;,<br>    <span class="hljs-keyword">throw</span>() &#123;<br>      <span class="hljs-comment">/// Here you can manually control the asynchronous iterator to be &quot;aborted&quot; and released</span><br>    &#125;,<br>  &#125;;<br>&#125;<br><br><span class="hljs-keyword">async</span> *<span class="hljs-title function_">waterOverflow</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">do</span> &#123;<br>        <span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">await</span> <span class="hljs-title function_">loopRustBuffer</span>().<span class="hljs-title function_">next</span>();<br>        <span class="hljs-comment">/// Data-based specification to define when to end</span><br>        <span class="hljs-comment">// if (isWaitingData &gt; this.heightWaterMark) &#123;</span><br>        <span class="hljs-comment">//   console.log(</span><br>        <span class="hljs-comment">//     &quot;waterOverflow====&gt;&quot;,</span><br>        <span class="hljs-comment">//     isWaitingData,</span><br>        <span class="hljs-comment">//     heightWaterMark</span><br>        <span class="hljs-comment">//   );</span><br>        <span class="hljs-comment">//   break;</span><br>        <span class="hljs-comment">// &#125;</span><br>        <span class="hljs-keyword">if</span> (!buffer.<span class="hljs-property">done</span>) &#123;<br>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">isWaitingData</span>++;<br>        &#125;<br>        <span class="hljs-keyword">yield</span> buffer;<br>        <span class="hljs-comment">/// Here is the point, use do-while instead of finally, you can avoid stack overflowã€‚</span><br>    &#125; <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>);<br>  &#125;<br><br>(<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">let</span> num <span class="hljs-keyword">of</span> <span class="hljs-title function_">waterOverflow</span>()) &#123;<br>    <span class="hljs-keyword">if</span> (!num.<span class="hljs-property">done</span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;webView.waterOverflow:&quot;</span>, num);<br>    &#125;<br>  &#125;<br>&#125;)();<br><br></code></pre></div></td></tr></table></figure>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/deno-javascript/">deno javascript</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/12/31/2022%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">2022å¹´ç»ˆæ€»ç»“</span>
                        <span class="visible-mobile">Vorheriger</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/08/08/BFS%E5%BC%80%E5%8F%91%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/">
                        <span class="hidden-mobile">BFSå¼€å‘é—®é¢˜æ±‡æ€»</span>
                        <span class="visible-mobile">NÃ¤chster</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <script type="text/javascript">
    Fluid.utils.loadComments('#comments', function() {
      var light = 'github-light';
      var dark = 'github-dark';
      var schema = document.documentElement.getAttribute('data-user-color-scheme');
      if (schema === 'dark') {
        schema = dark;
      } else {
        schema = light;
      }
      window.UtterancesThemeLight = light;
      window.UtterancesThemeDark = dark;
      var s = document.createElement('script');
      s.setAttribute('src', 'https://utteranc.es/client.js');
      s.setAttribute('repo', 'waterbang/Comment');
      s.setAttribute('issue-term', 'pathname');
      
      s.setAttribute('label', 'utterances');
      
      s.setAttribute('theme', schema);
      s.setAttribute('crossorigin', 'anonymous');
      document.getElementById('comments').appendChild(s);
    })
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Suchen</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">Stichwort</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a>
  </div>
  

  
  <!-- å¤‡æ¡ˆä¿¡æ¯ -->
  <div class="beian">
    <span>
      <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
        é—½ICPå¤‡18009949å·-2
      </a>
    </span>
    
  </div>


  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>












  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?58e161bf4b884b2aa577f323f137ac0f";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  

  

  

  

  





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ ä¿æŒåœ¨æœ€åº•éƒ¨ -->
<script  src="/js/boot.js" ></script>


</body>
</html>
